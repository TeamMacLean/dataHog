<% include head.ejs %>

<input type="file" id="siofu_input"/>

<script src="/components/socketio-file-upload/client.min.js"></script>

<script>
    $(function () {

        var lastTime = null;
        var lastBytesLoaded = null;

        var socket = io(window.location.host);
        var uploader = new SocketIOFileUpload(socket);
        uploader.listenOnInput(document.getElementById("siofu_input"));

        uploader.addEventListener("complete", function (event) {
//            console.log(event);
            console.log("Upload Complete: " + event.file.name);
        });
        uploader.addEventListener("choose", function (event) {
            console.log("Files Chosen: " + event.files);
        });
        uploader.addEventListener("start", function (event) {
            event.file.meta.hello = "World";
        });
        uploader.addEventListener("progress", function (event) {
            var timeNow = new Date()

            if (lastTime && lastBytesLoaded) {
                var difference = timeNow.getTime() - lastTime.getTime();
                var seconds = Math.floor(difference * 1000);
                var SCALE = 1 / seconds;
                var bytesMoved = event.bytesLoaded - lastBytesLoaded;


                var a = formatSizeUnits(bytesMoved * SCALE)

//                console.log(mbPerSecond, 'per second');

            }
            lastTime = timeNow;
            lastBytesLoaded = event.bytesLoaded;

            console.log(a, 'per second');
//            console.log(event);
//            console.log("File is", event.bytesLoaded / event.file.size * 100, "percent loaded");


        });

        function formatSizeUnits(bytes) {
            if (bytes >= 1073741824) {
                bytes = (bytes / 1073741824).toFixed(2) + ' GB';
            }
            else if (bytes >= 1048576) {
                bytes = (bytes / 1048576).toFixed(2) + ' MB';
            }
            else if (bytes >= 1024) {
                bytes = (bytes / 1024).toFixed(2) + ' KB';
            }
            else if (bytes > 1) {
                bytes = bytes + ' bytes';
            }
            else if (bytes == 1) {
                bytes = bytes + ' byte';
            }
            else {
                bytes = '0 byte';
            }
            return bytes;
        }


        uploader.addEventListener("load", function (event) {
            console.log("File Loaded: " + event.file.name);
//            console.log(event);
        });
        uploader.addEventListener("error", function (event) {
            console.log("Error: " + event.message);
//            console.log(event.message);
            if (event.code === 1) {
                alert("Don't upload such a big file");
            }
        });
//        uploader.maxFileSize = 1024 * 1000;
        uploader.useBuffer = true;
        console.log(uploader.chunkSize)
//        uploader.chunkDelay = 100;

    })
</script>

<% include foot.ejs %>